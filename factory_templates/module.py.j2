"""
{{ module_name }} - {{ module_description }}

Generated from: {{ spec_file }}
Generated on: {{ timestamp }}
Spec SHA256: {{ spec_hash }}

REGENERATION: python factory.py {{ spec_file }}

WARNING: Manual edits will be overwritten on regeneration.
         Update the spec instead.
"""

from typing import {{ type_imports|join(', ') }}
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
{% if has_optional %}Optional, {% endif %}

# ═══════════════════════════════════════════════════════════════════════════
# DATA STRUCTURES
# ═══════════════════════════════════════════════════════════════════════════

{% for ds in dataclasses %}
@dataclass
class {{ ds.name }}:
    """
    {{ ds.description }}

    {% if ds.requirement_id -%}
    Implements: {{ ds.requirement_id }}
    {% endif -%}
    Spec: {{ spec_file }}#section-{{ ds.section }}
    """
{%- for field in ds.fields %}
    {{ field.name }}: {{ field.type }}{{ ' = ' + field.default if field.default else '' }}  # {{ field.description }}
{%- endfor %}
{% if ds.has_methods %}

{%- for method in ds.methods %}
    def {{ method.name }}({{ method.params }}) -> {{ method.return_type }}:
        """{{ method.description }}"""
        {{ method.body|indent(8) }}
{% endfor -%}
{% endif %}

{% endfor %}

# ═══════════════════════════════════════════════════════════════════════════
# ENUMS
# ═══════════════════════════════════════════════════════════════════════════

{% for enum in enums %}
class {{ enum.name }}({{ enum.base_type }}):
    """
    {{ enum.description }}

    {% if enum.requirement_id -%}
    Implements: {{ enum.requirement_id }}
    {% endif -%}
    Spec: {{ spec_file }}#section-{{ enum.section }}
    """
{%- for value in enum.values %}
    {{ value.name }} = "{{ value.value }}"
{%- endfor %}

{% endfor %}

# ═══════════════════════════════════════════════════════════════════════════
# MAIN CLASSES
# ═══════════════════════════════════════════════════════════════════════════

{% for cls in classes %}
class {{ cls.name }}:
    """
    {{ cls.description }}

    {% if cls.requirement_ids -%}
    Implements: {{ cls.requirement_ids|join(', ') }}
    {% endif -%}
    Spec: {{ spec_file }}

    {% if cls.attributes -%}
    Attributes:
    {%- for attr in cls.attributes %}
        {{ attr.name }}: {{ attr.description }}
    {%- endfor %}
    {%- endif %}
    """

    def __init__({{ cls.init_params }}):
        """
        Initialize {{ cls.name }}.

        {% if cls.init_requirement_id -%}
        Implements: {{ cls.init_requirement_id }}
        {% endif -%}

        Args:
        {%- for param in cls.init_param_list %}
            {{ param.name }}: {{ param.description }}
        {%- endfor %}
        """
        {{ cls.init_body|indent(8) }}

{% for method in cls.methods %}
    def {{ method.name }}({{ method.params }}) -> {{ method.return_type }}:
        """
        {{ method.description }}

        {% if method.requirement_id -%}
        Implements: {{ method.requirement_id }}
        Spec: {{ spec_file }}#section-{{ method.section }}
        {% endif -%}

        {% if method.param_descriptions -%}
        Args:
        {%- for param in method.param_descriptions %}
            {{ param.name }}: {{ param.description }}
        {%- endfor %}
        {%- endif %}

        {% if method.return_description -%}
        Returns:
            {{ method.return_description }}
        {%- endif %}

        {% if method.raises -%}
        Raises:
        {%- for exc in method.raises %}
            {{ exc.type }}: {{ exc.description }}
        {%- endfor %}
        {%- endif %}

        {% if method.troubleshooting -%}
        Troubleshooting:
        {%- for item in method.troubleshooting %}
            - {{ item }}
        {%- endfor %}
        {%- endif %}
        """
        {{ method.body|indent(8) }}

{% endfor %}
{% endfor %}

# ═══════════════════════════════════════════════════════════════════════════
# HELPER FUNCTIONS
# ═══════════════════════════════════════════════════════════════════════════

{% for func in functions %}
def {{ func.name }}({{ func.params }}) -> {{ func.return_type }}:
    """
    {{ func.description }}

    {% if func.requirement_id -%}
    Implements: {{ func.requirement_id }}
    Spec: {{ spec_file }}#section-{{ func.section }}
    {% endif -%}

    {% if func.param_descriptions -%}
    Args:
    {%- for param in func.param_descriptions %}
        {{ param.name }}: {{ param.description }}
    {%- endfor %}
    {%- endif %}

    {% if func.return_description -%}
    Returns:
        {{ func.return_description }}
    {%- endif %}
    """
    {{ func.body|indent(4) }}

{% endfor %}
